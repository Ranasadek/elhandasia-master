<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Categories</title>
  <link rel="icon" type="image/png" href="img/Logo.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <link rel="stylesheet" href="css/main.css">

  <style>
    /* الحل النهائي لمنع اختفاء أي عمود في الموبايل */
    
    @media screen and (max-width: 1024px) {
      /* 1. إخفاء التايتل لتوفير مساحة */
      .title-section p { display: none !important; }
      
      /* 2. جعل الحاوية تسمح بالتمرير الجانبي */
      .table-container {
        overflow-x: auto !important;
        display: block !important;
        -webkit-overflow-scrolling: touch;
      }

      table {
        min-width: 600px !important; /* يضمن مساحة كافية للأعمدة */
        width: 100%;
      }

      /* 3. إجبار الأعمدة على الظهور (لإلغاء أي display: none قديم) */
      th, td {
        display: table-cell !important; 
        padding: 10px 8px !important;
        font-size: 13px !important;
      }

      /* 4. معالجة عمود الوصف (Description أو Summary) */
      td:nth-child(2) {
        white-space: normal !important; /* يسمح للنص بالنزول لسطر جديد */
        min-width: 150px !important;
      }
      
      /* 5. عمود الأكشن */
      td:last-child {
        width: 80px !important;
      }
    }
  </style>
</head>
<body>

<header class="main-header">
  <div class="logo-area">
    <div class="hamburger">&#9776;</div>
    <img src="img/Logo.png" alt="Logo" class="logo-img">
    <div class="logo-info">
      <h2>Elhandasiya</h2>
      <p>Admin Panel</p>
    </div>
  </div>

  <div class="header-body">
    <div class="welcome">
      <h1>Welcome back, Admin</h1>
    </div>
    <div class="user-info">
      <strong>Admin User</strong>
    </div>
  </div>
</header>

<div class="page-container">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="close-btn">&times;</div> <!-- زر الإكس -->
    <nav class="menu">
      <a href="index.html" class="item"><i data-lucide="home"></i>Home</a>
      <a href="Dashboard.html" class="item "><i data-lucide="layout-grid"></i>Dashboard</a>
      <a href="product.html" class="item "><i data-lucide="package"></i>Products</a>
      <a href="categories.html" class="item active"> <i data-lucide="folder"></i>Categories</a>
      <a href="order.html" class="item"><i data-lucide="shopping-cart"></i>Orders</a>
      <a href="brands.html" class="item"><i data-lucide="award"></i>Brands</a>
      <a href="governorates.html" class="item "><i data-lucide="truck"></i>Governorates</a>
      <!-- <a href="#" class="item"><i data-lucide="image"></i>Banners</a> -->
      <!-- <a class="item"><i data-lucide="settings"></i>Settings</a> -->
    </nav>
  </aside>

  <main class="main-content">
    <header>
      <div class="title-section">
        <h1>Categories</h1>
        <p>Manage product categories</p>
      </div>
    </header>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Description</th>
            <th style="text-align: center;">Actions</th>
          </tr>
        </thead>
        <tbody id="categoryTableBody">
          </tbody>
      </table>
    </div>
  </main>
</div>

<script>
  // 1. الإعدادات والروابط الأساسية
  const BASE_URL = 'https://el-handasia.runasp.net';
  const getToken = () => (localStorage.getItem('userToken') || localStorage.getItem('token'))?.trim();

  // الهوية البصرية (الألوان)
  const COLORS = {
      primary: '#2563eb', // الأزرق للأزرار (Add Now)
      accent: '#ea580c',  // البرتقالي للخط الطولي الجانبي
      danger: '#ef4444',  // الأحمر للحذف
      textGray: '#64748b' // الرمادي للسهم والنصوص الجانبية
  };

  // 2. التشغيل عند تحميل الصفحة
  document.addEventListener('DOMContentLoaded', () => {
      const token = getToken();
      if (!token) {
          window.location.href = 'login.html';
          return;
      }
      fetchCategories();
      if (typeof lucide !== 'undefined') lucide.createIcons();
  });

  // 3. جلب الأقسام الرئيسية
  async function fetchCategories() {
      try {
          const response = await fetch(`${BASE_URL}/api/admin/categories`, {
              headers: { 'Authorization': `Bearer ${getToken()}` }
          });

          if (response.status === 401) {
              window.location.href = 'login.html';
              return;
          }

          const result = await response.json();
          const categories = Array.isArray(result) ? result : (result.data || []);
          renderCategoryTable(categories);
      } catch (error) {
          console.error("Error fetching categories:", error);
      }
  }

  // 4. بناء الجدول الرئيسي
  function renderCategoryTable(categories) {
      const tbody = document.getElementById('categoryTableBody');
      if (!tbody) return;

      tbody.innerHTML = categories.map(cat => `
          <tr id="category-row-${cat.id || cat.Id}" style="border-bottom: 1px solid #f1f5f9;">
              <td style="font-weight:600; padding: 12px; cursor:pointer;" onclick="toggleSubCategories(${cat.id || cat.Id})">
                  <div style="display: flex; align-items: center; gap: 8px;">
                      <i data-lucide="chevron-right" id="icon-${cat.id || cat.Id}" 
                         style="width: 18px; height: 18px; color: ${COLORS.textGray}; transition: transform 0.3s;"></i>
                      <span>${cat.name || cat.Name}</span>
                  </div>
              </td>
              <td style="color: ${COLORS.textGray}; padding: 12px;">${cat.description || cat.Description || 'No Description'}</td>
              <td style="text-align: center; padding: 12px;">
                  <div style="display: flex; justify-content: center; gap: 10px;">
                      <button onclick="openAddSubCategoryModal(${cat.id || cat.Id}, '${cat.name || cat.Name}')" 
                              title="Add Sub Category"
                              style="background:#f0fdf4; color:#16a34a; border:none; padding:8px; border-radius:6px; cursor:pointer;">
                          <i data-lucide="plus-circle" style="width: 18px; height: 18px;"></i>
                      </button>

                      <button onclick="manageSpecs(${cat.id || cat.Id}, '${cat.name || cat.Name}')" 
                              style="background:#eff6ff; color:${COLORS.primary}; border:none; padding:8px; border-radius:6px; cursor:pointer;">
                          <i data-lucide="settings" style="width: 18px; height: 18px;"></i>
                      </button>

                      <button onclick="confirmDeleteCategory(${cat.id || cat.Id}, '${cat.name || cat.Name}')" 
                              style="background: transparent; color:${COLORS.danger}; border:none; padding:8px; cursor:pointer;">
                          <i data-lucide="trash-2" style="width: 18px; height: 18px;"></i>
                      </button>
                  </div>
              </td>
          </tr>
          <tr id="sub-row-${cat.id || cat.Id}" style="display:none; background: #fafafa;">
              <td colspan="3" style="padding: 0;">
                  <div id="sub-container-${cat.id || cat.Id}" 
                       style="padding: 10px 15px 20px 50px; border-left: 4px solid ${COLORS.accent}; margin: 10px 0;">
                      </div>
              </td>
          </tr>
      `).join('');
      
      if (typeof lucide !== 'undefined') lucide.createIcons();
  }

  // 5. وظائف الـ SubCategories
  async function toggleSubCategories(catId) {
      const subRow = document.getElementById(`sub-row-${catId}`);
      const icon = document.getElementById(`icon-${catId}`);
      
      if (subRow.style.display === 'none') {
          subRow.style.display = 'table-row';
          icon.style.transform = 'rotate(90deg)';
          fetchAndRenderSubCategories(catId);
      } else {
          subRow.style.display = 'none';
          icon.style.transform = 'rotate(0deg)';
      }
  }

  async function fetchAndRenderSubCategories(catId) {
      const container = document.getElementById(`sub-container-${catId}`);
      container.innerHTML = '<p style="color:#94a3b8; font-size:12px;">Loading...</p>';

      try {
          const response = await fetch(`${BASE_URL}/api/SubCategories/by-category/${catId}`, {
              headers: { 'Authorization': `Bearer ${getToken()}` }
          });
          const subs = await response.json();

          if (!subs || subs.length === 0) {
              container.innerHTML = '<p style="color:#94a3b8; font-size:13px;">No sub-categories available.</p>';
              return;
          }

          container.innerHTML = `
              <table style="width:100%; border-collapse: collapse;">
                  <thead>
                      <tr style="text-align:left; color:#94a3b8; font-size:11px; text-transform: uppercase;">
                          <th style="padding:10px;">Sub-Name</th>
                          <th style="padding:10px;">Description</th>
                          <th style="padding:10px; text-align:center;">Action</th>
                      </tr>
                  </thead>
                  <tbody>
                      ${subs.map(sub => `
                          <tr style="border-top: 1px solid #f1f5f9;">
                              <td style="padding:10px; font-size:13px; font-weight:500;">${sub.name || sub.Name}</td>
                              <td style="padding:10px; font-size:12px; color:${COLORS.textGray};">
                                  ${sub.description || sub.Description || sub.subCategoryDescription || '-'}
                              </td>
                              <td style="padding:10px; text-align:center;">
                                  <button onclick="handleDeleteSub(${sub.id || sub.Id}, ${catId})" 
                                          style="background:none; border:none; color:${COLORS.danger}; cursor:pointer;">
                                      <i data-lucide="trash-2" style="width:16px; height:16px;"></i>
                                  </button>
                              </td>
                          </tr>
                      `).join('')}
                  </tbody>
              </table>
          `;
          if (typeof lucide !== 'undefined') lucide.createIcons();
      } catch (e) {
          container.innerHTML = '<p style="color:red; font-size:12px;">Error loading data.</p>';
      }
  }

  async function openAddSubCategoryModal(catId, catName) {
      const { value: formValues } = await Swal.fire({
          title: `Add Sub-Category to ${catName}`,
          html:
              `<input id="sub-name" class="swal2-input" placeholder="Sub Category Name" style="width:80%;">` +
              `<input id="sub-desc" class="swal2-input" placeholder="Description (Optional)" style="width:80%;">`,
          showCancelButton: true,
          confirmButtonText: 'Add Now',
          confirmButtonColor: COLORS.primary, // زر أزرق
          preConfirm: () => {
              const name = document.getElementById('sub-name').value;
              const description = document.getElementById('sub-desc').value;
              if (!name) {
                  Swal.showValidationMessage('Name is required');
                  return false;
              }
              return { name, description, categoryId: catId };
          }
      });

      if (formValues) {
          try {
              const response = await fetch(`${BASE_URL}/api/SubCategories`, {
                  method: 'POST',
                  headers: { 
                      'Authorization': `Bearer ${getToken()}`,
                      'Content-Type': 'application/json' 
                  },
                  body: JSON.stringify(formValues)
              });
              if (response.ok) {
                  Swal.fire({ icon: 'success', title: 'Added!', showConfirmButton: false, timer: 1500 });
                  fetchAndRenderSubCategories(catId); 
              }
          } catch (error) { console.error(error); }
      }
  }

  async function handleDeleteSub(subId, catId) {
      const result = await Swal.fire({
          title: 'Are you sure?',
          text: "Delete this sub-category?",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: COLORS.danger
      });
      if (result.isConfirmed) {
          try {
              const response = await fetch(`${BASE_URL}/api/SubCategories/${subId}`, {
                  method: 'DELETE',
                  headers: { 'Authorization': `Bearer ${getToken()}` }
              });
              if (response.ok) fetchAndRenderSubCategories(catId);
          } catch (e) { console.error(e); }
      }
  }

  // 6. إدارة المواصفات (Specifications) - الكود كامل
  async function manageSpecs(catId, catName) {
      Swal.fire({
          title: `Manage Specifications: ${catName}`,
          html: `
              <div id="specs-list-container" style="text-align: left; max-height: 250px; overflow-y: auto; margin-bottom: 20px; border: 1px solid #eee; padding: 10px; border-radius: 8px; background: #fafafa;">
                  <p style="text-align:center; font-size: 13px; color: #666;">Loading specs...</p>
              </div>
              <div style="display: flex; gap: 8px; align-items: center;">
                  <input id="new-spec-input" type="text" placeholder="New spec name..." 
                         style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; outline: none;">
                  <button onclick="handleAddSpec(${catId})" 
                          style="background: ${COLORS.primary}; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold;">
                      Add
                  </button>
              </div>
          `,
          showConfirmButton: false,
          showCancelButton: true,
          cancelButtonText: 'Close',
          didOpen: () => refreshSpecsList(catId)
      });
  }

  async function refreshSpecsList(catId) {
      const container = document.getElementById('specs-list-container');
      if (!container) return;
      try {
          const response = await fetch(`${BASE_URL}/api/admin/categories/${catId}/specifications`, {
              headers: { 'Authorization': `Bearer ${getToken()}` }
          });
          const specs = response.ok ? await response.json() : [];
          container.innerHTML = specs.length > 0 ? specs.map(s => `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee;">
                  <span style="font-size: 14px;">${s.specificationName || s.name || s.Name}</span>
                  <button onclick="handleDeleteSpec(${catId}, ${s.id || s.Id})" style="background:transparent; border:none; color:${COLORS.danger}; cursor:pointer;">
                      <i data-lucide="trash-2" style="width: 18px; height: 18px;"></i>
                  </button>
              </div>
          `).join('') : '<p style="text-align:center; padding: 10px;">No specs yet.</p>';
          if (typeof lucide !== 'undefined') lucide.createIcons();
      } catch (e) { container.innerHTML = 'Error loading specs.'; }
  }

  async function handleAddSpec(catId) {
      const input = document.getElementById('new-spec-input');
      const name = input.value.trim();
      if (!name) return;
      try {
          const response = await fetch(`${BASE_URL}/api/admin/categories/${catId}/specifications`, {
              method: 'POST',
              headers: { 'Authorization': `Bearer ${getToken()}`, 'Content-Type': 'application/json' },
              body: JSON.stringify({ specificationName: name })
          });
          if (response.ok) { input.value = ''; refreshSpecsList(catId); }
      } catch (e) { console.error(e); }
  }

  async function handleDeleteSpec(catId, specId) {
      try {
          const response = await fetch(`${BASE_URL}/api/admin/categories/${catId}/specifications/${specId}`, {
              method: 'DELETE',
              headers: { 'Authorization': `Bearer ${getToken()}` }
          });
          if (response.ok) refreshSpecsList(catId);
      } catch (e) { console.error(e); }
  }

  async function confirmDeleteCategory(id, name) {
      const result = await Swal.fire({
          title: 'Delete Category?',
          text: `Are you sure you want to delete "${name}"?`,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: COLORS.danger
      });
      if (result.isConfirmed) {
          try {
              const response = await fetch(`${BASE_URL}/api/admin/categories/${id}`, {
                  method: 'DELETE',
                  headers: { 'Authorization': `Bearer ${getToken()}` }
              });
              if (response.ok) fetchCategories();
          } catch (e) { console.error(e); }
      }
  }
</script>





<script>
  lucide.createIcons();

  document.addEventListener('DOMContentLoaded', () => {

    // -------- Sidebar Hamburger --------
    const sidebarHamburger = document.querySelector('.hamburger'); // متغير مختلف عشان ما يتعارضش
    const sidebar = document.querySelector('.sidebar');
    const sidebarCloseBtn = document.querySelector('.close-btn');

    if (sidebarHamburger && sidebar && sidebarCloseBtn) {
      sidebarHamburger.addEventListener('click', () => {
        sidebar.classList.add('show'); // فتح الـ sidebar
      });

      sidebarCloseBtn.addEventListener('click', () => {
        sidebar.classList.remove('show'); // غلق الـ sidebar
      });
    }

    // -------- Sidebar Active Toggle --------
    const menuItems = document.querySelectorAll('.menu .item');

    menuItems.forEach(item => {
      item.addEventListener('click', () => {
        // إزالة active من كل العناصر
        menuItems.forEach(el => el.classList.remove('active'));

        // إضافة active للعنصر اللي اتضغط
        item.classList.add('active');
      });
    });

    // أي كود جديد ممكن تضيفيه هنا بدون مشاكل
    // مثال: hamburger آخر لقائمة موبايل
    const mobileMenuIcon = document.querySelector('.mobile-menu-icon'); // لو موجود
    const mobileCategories = document.querySelector('.mobile-categories'); // لو موجود

    if (mobileMenuIcon && mobileCategories) {
      mobileMenuIcon.addEventListener('click', () => {
        mobileCategories.classList.toggle('show');
      });

      document.addEventListener('click', (e) => {
        if (!mobileCategories.contains(e.target) && !mobileMenuIcon.contains(e.target)) {
          mobileCategories.classList.remove('show');
        }
      });
    }

  });
</script>
</body>
</html>