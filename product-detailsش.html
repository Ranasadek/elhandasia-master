
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elhandasia E-commerce Header (Final Code & Dynamic Hover)</title>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* أضف فقط هذه الأنماط الجديدة بدون تغيير التصميم الحالي */
        
        /* شريط تمرير للصور المصغرة فقط */
        .thumbnails {
            overflow-y: auto !important;
            max-height: 500px !important;
            scrollbar-width: thin !important;
            scrollbar-color: #FF6B00 #f5f5f5 !important;
        }
        
        /* تخصيص شريط التمرير (ويب كيت) */
        .thumbnails::-webkit-scrollbar {
            width: 6px !important;
        }
        
        .thumbnails::-webkit-scrollbar-track {
            background: #f5f5f5 !important;
            border-radius: 3px !important;
        }
        
        .thumbnails::-webkit-scrollbar-thumb {
            background: #FF6B00 !important;
            border-radius: 3px !important;
        }
        
        .thumbnails::-webkit-scrollbar-thumb:hover {
            background: #e65c00 !important;
        }
        
        /* تأكد أن الصور المصغرة تبقى كما هي */
        .thumbnails img {
            flex-shrink: 0 !important;
        }
        
        /* منع تأثير التمرير على الصفحة */
        .thumbnails {
            overscroll-behavior: contain !important;
        }

        .btn-order:hover {
            background: linear-gradient(135deg, #27ae60, #219653) !important;
            transform: translateY(-3px) !important;
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4) !important;
            
        }

        .btn-order:active {
            transform: translateY(-1px) !important;
        }

        /* Action buttons container */
        .action-btns {
            display: flex !important;
            gap: 20px !important;
            margin-top: 30px !important;
            flex-wrap: wrap !important;
            align-items: center !important;
        }

        /* Responsive design for buttons */
        @media (max-width: 768px) {
    .action-btns {
        display: flex !important;
        flex-direction: row !important; /* تغيير الاتجاه ليكون أفقي */
        gap: 10px !important;           /* تقليل المسافة لتناسب العرض */
        width: 100% !important;
    }
    
    .btn-cart, .btn-order {
        flex: 1 !important;             /* جعل الزرين يقتسمان المساحة بالتساوي */
        min-width: 0 !important;        /* إلغاء العرض الكامل القديم */
        padding: 12px 5px !important;   /* تقليل الحشو الجانبي لمنع خروج النص */
        font-size: 14px !important;     /* تصغير الخط قليلاً إذا لزم الأمر */
        text-align: center !important;
    }
 .containers h1{
    font-size:22px;
    margin:0 0 6px;
    font-weight:600;
    margin-left: 15px;
  }
  p.subtitle{
    margin:0 0 28px;
    color:#71717A;
    font-size:13px;
    margin-left: 15px;
  }

}
        /* Add to Cart button styling for consistency */
        .btn-cart {
            background: linear-gradient(135deg, #FF6B00, #e65c00) !important;
            color: white !important;
            border: none !important;
            padding: 14px 28px !important;
            border-radius: 8px !important;
            font-size: 16px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            min-width: 180px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 10px !important;
            box-shadow: 0 4px 15px rgba(255, 107, 0, 0.3) !important;
            letter-spacing: 0.5px !important;
            margin-top: 148px;
           
        }

        .btn-cart:hover {
            background: linear-gradient(135deg, #e65c00, #cc5200) !important;
            transform: translateY(-3px) !important;
            box-shadow: 0 6px 20px rgba(255, 107, 0, 0.4) !important;
        }

        .btn-cart:active {
            transform: translateY(-1px) !important;
        }
        
        /* زر Add to Cart في صفحة التفاصيل */
        .btn-cart {
            background: #FF6B00 !important;
            color: white !important;
            border: none !important;
            padding: 12px 24px !important;
            border-radius: 4px !important;
            font-size: 16px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            min-width: 160px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 8px !important;
        }
        
        .btn-cart:hover {
            background: #e65c00 !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 5px 15px rgba(255, 107, 0, 0.3) !important;
        }
        
        /* زر Order Now في صفحة التفاصيل */
        .btn-order {
            background: #2ecc71 !important;
            color: white !important;
            border: none !important;
            padding: 12px 24px !important;
            border-radius: 4px !important;
            font-size: 16px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            min-width: 160px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 8px !important;
            margin-top: 148px;
        }
        
        .btn-order:hover {
            background: #27ae60 !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3) !important;
        }
        
        /* حاوية الأزرار */
        .action-btns {
            display: flex !important;
            gap: 15px !important;
            margin-top: 25px !important;
            flex-wrap: wrap !important;
        }
    </style>
</head>
<body>
    <header class="elhandasia-header">
        <div class="top-bar">
            <a href="login.html" id="mainLoginBtn" class="btn-login">Log In</a>
            <div class="contact-info">
                <span class="contact-text">Contact Us</span>
                <a href="tel:01095938913" class="contact-number">01095938913</a>
            </div>
        </div>

        <div class="main-header-content">
            <div class="logo-container">
                <img src="img/Logo.png" alt="Elhandasia Logo" class="logo-image">
                <h2>Elhandasia</h2>
            </div>
            
            <div class="search-bar">
             
                <input type="text" placeholder="Search for product...">
                <button class="search-icon-btn"><i class="fas fa-search"></i></button>
            </div>
            <div class="user-icons">
                <a href="settings.html" id="userAccountIcon" class="icon-item" style="display: none;">
                    <i class="far fa-user"></i>
                    <span class="icon-label">Account</span>
                </a>
            </div>
             
            <a href="javascript:void(0)" onclick="handleCartClick()" class="icon-item"> 
                <i class="fas fa-shopping-cart"></i>
                <span class="icon-label">Cart</span>
            </a>
            </div>
        </div>
    </header>
    
    <div class="container" id="product-page">
        <!-- Product will be loaded here -->
    </div>
    
    <div class="section2">
        <div class="services">
            <div class="service-box">
                <img src="img/2.jpeg" alt="Free Shipping">
                <div class="service-title">Free Shipping</div>
                <div class="service-text">Orders above 20K EGP</div>
            </div>
            
            <div class="divider" aria-hidden="true"></div>
            
            <div class="service-box">
                <img src="img/3.jpeg" alt="Secure Payment">
                <div class="service-title">Secure Payment</div>
                <div class="service-text">Got 100% Payment Safe</div>
            </div>
            
            <div class="divider" aria-hidden="true"></div>
            
            <div class="service-box">
                <div class="support-icon">
                    <img src="img/4.jpeg" class="icon-base" alt="Support">
                </div>
                <div class="service-title">Support 24/7</div>
                <div class="service-text">Top quality 24/7 Support</div>
            </div>
            
            <div class="divider" aria-hidden="true"></div>
            
            <div class="service-box">
                <img src="img/6.jpeg" alt="Money Back">
                <div class="service-title">100% Money Back</div>
                <div class="service-text">Customers Money Backs</div>
            </div>
            
            <div class="divider" aria-hidden="true"></div>
            
            <div class="service-box">
                <img src="img/8.jpeg" alt="Quality Products">
                <div class="service-title">Quality Products</div>
                <div class="service-text">15 Years of Quality and Trust</div>
            </div>
        </div>
    </div>
    
    <div class="containers">
        <h1>Products related to this item</h1>
        <p class="subtitle">Modern, Powerful Selection</p>
        <div class="grid2" id="related-products-grid">
            <!-- Related products will be loaded here -->
        </div>
    </div>

    <footer class="site-footer" aria-label="Footer">
        <div class="footer-inner">
            
            <div>
                <div class="footer-footer">
                    <div class="footer-header">
                         <div class="footer-left">
                            <img src="img/Logo.png" alt="El-Handasiya Logo">
                        </div>
                        <div class="footer-right">
                            <h3>El-Handasia</h3>
                            <p style="margin: 0; ">Electronics & Technology</p>
                        </div>
                    </div>
      
                    <p class="footer-description">Your trusted partner for electronics, laptops, CCTV systems, and computer accessories in Egypt.</p>
                    <div class="socials" aria-hidden="false">
                      <a href="https://www.facebook.com/share/16uDx46Ntk/" target="_blank" rel="noopener noreferrer" aria-label="facebook">
                          <i class="fab fa-facebook-f"></i>
                      </a>
                  
                      <a href="#" target="_blank" rel="noopener noreferrer" aria-label="twitter">
                          <i class="fab fa-twitter"></i>
                      </a>
                  
                      <a href="#" target="_blank" rel="noopener noreferrer" aria-label="instagram">
                          <i class="fab fa-instagram"></i>
                      </a>
                  
                      <a href="#" target="_blank" rel="noopener noreferrer" aria-label="youtube">
                          <i class="fab fa-youtube"></i>
                      </a>
                  </div>
                  
                </div>
            </div>
      
            <div class="footer-col">
                <h4>Quick Links</h4>
                <nav class="links" aria-label="Quick Links">
                    <a href="#">About Us</a>
                    <a href="#">Contact Us</a>
                    <a href="#">Track Order</a>
                    <a href="#">Returns & Refunds</a>
                    <a href="#">Shipping Info</a>
                    <a href="#">FAQs</a>
                </nav>
            </div>
      
            <div class="footer-col">
                <h4>Categories</h4>
                <nav class="cats" aria-label="Categories">
                    <a href="#">Laptops</a>
                    <a href="#">Storage Devices</a>
                    <a href="#">CCTV Systems</a>
                    <a href="#">Accessories</a>
                    <a href="#">Keyboards & Mice</a>
                    <a href="#">Audio Devices</a>
                </nav>
            </div>
      
            <div class="footer-col contact">
                <h4>Contact Us</h4>
                
                <div class="contact-content">
                    
                    <div class="info">
                        <div class="row"><i class="fa-solid fa-location-dot"></i><div>Cairo, Egypt<br><small style="color:var(--muted)">Nasr City, Main Street</small></div></div>
                        
                        <div class="row">
                            <i class="fa-solid fa-phone"></i>
                            <div>
                                <a href="tel:+201234567890">+20 123 456 7890</a>
                            </div>
                        </div>
                        
                        <div class="row">
                            <i class="fa-regular fa-envelope"></i>
                            <div>
                                <a href="mailto:info@elhandasia.com">info@elhandasia.com</a>
                            </div>
                        </div>
                        
                        <div style="font-size:12px; color:var(--muted); margin-top:6px; text-align: left;">
                            <strong style="color:var(--white)">Working Hours:</strong><br>
                            Sat - Thu: 9:00 AM - 9:00 PM<br>
                            Friday: 2:00 PM - 9:00 PM
                        </div>
                    </div>
      
                    <a href="https://maps.app.goo.gl/YZeAaQPLviXbDjHDA?g_st=ac" target="_blank" class="map" aria-label="View location on Google Maps">
                        <img src="img/WhatsApp Image 2025-12-07 at 11.58.15 PM.jpeg" alt="Map location ">
                    </a>
                </div>
            </div>
        </div>
        
      
        <div class="footer-divider"></div>
      
        <div class="footer-bottom">
            <div class="copyright">© 2024 El-Handasia Company. All rights reserved.</div>
      
            <div class="developed" aria-hidden="false">
                <span class="by">Developed By</span>
                <span class="beta">BETA</span>
            </div>
            
            <div class="bottom-links">
                <a href="#">Privacy Policy</a>
                <a href="#">Terms of Service</a>
                <a href="#">Cookie Policy</a>
            </div>
        </div>
      </footer>
    <!-- Modal HTML -->
 
    <div id="modalOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; justify-content: center; align-items: center;">
        <div class="modal-content"  style="background: white; padding: 40px; border-radius: 25px; width: 90%;    max-width: 399px;
    height: 100%; text-align: center; box-shadow: 0 15px 50px rgba(0,0,0,0.2); position: relative; font-family: sans-serif;">
            <a href="javascript:void(0)" onclick="closeModal()" style="color: #FF6B00; text-decoration: none; font-size: 14px; display: block; margin-bottom: 20px; font-weight: 500; text-align: left;">
                <i class="fas fa-arrow-left"></i> Back to Product
            </a>
            <div style="font-size: 28px; font-weight: bold; margin-bottom: 25px; color: #111;">Order Summary</div>
            
            <div id="summaryBox" style="background: #fcfcfc; border: 1px solid #f0f0f0; border-radius: 15px; padding: 20px; margin-bottom: 25px;">
                <!-- Content will be loaded here -->
            </div>

            <button onclick="sendToWhatsApp()" style="background: #25D366; color: white; border: none; padding: 18px; width: 100%; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 12px; transition: all 0.3s ease;">
                <i class="fab fa-whatsapp" style="font-size: 24px;"></i> Send Order via WhatsApp
            </button>
            
            <p style="color: #777; font-size: 12px; margin-top: 15px;">
                <i class="fas fa-info-circle"></i> Our team will contact you within 24 hours to confirm your order.
            </p>
        </div>
    </div>

    <script>
        const API_URL = "https://el-handasia.runasp.net";
        const WHATSAPP_NUMBER = "201018413535";
        let currentProductData = null;

        // Fix image URLs - handle both absolute URLs and relative paths
        function fixImg(p) { 
            if (!p) return 'img/placeholder.jpg';
            // If already a full URL, return as is
            if (p.startsWith('http://') || p.startsWith('https://')) return p;
            // If starts with /, it's an absolute path from API
            if (p.startsWith('/')) return `${API_URL}${p}`;
            // Otherwise, prepend API_URL
            return `${API_URL}/${p.replace(/\\/g, '/')}`;
        }

        // Change quantity
        function changeQty(v) {
            let q = document.getElementById('qty');
            if (q) {
                let val = parseInt(q.value) + v;
                if (val >= 1) q.value = val;
            }
        }

        // Swap main image
        function swap(el) {
            const bigImg = document.getElementById('big-img');
            if (bigImg) bigImg.src = el.src;
            document.querySelectorAll('.thumbnails img').forEach(img => img.classList.remove('active'));
            el.classList.add('active');
        }

        // Check if user is logged in
        function isUserLoggedIn() {
            const token = localStorage.getItem("token");
            return token !== null && token !== undefined && token !== '';
        }

        // Show login required message
        function showLoginRequired(action) {
            if (typeof Swal === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/sweetalert2@11';
                script.onload = function() {
                    showLoginRequired(action);
                };
                document.head.appendChild(script);
                return;
            }
            
            Swal.fire({
                icon: 'warning',
                title: 'Login Required',
                html: `
                    <div style="text-align: center;">
                        <i class="fas fa-user-lock" style="font-size: 48px; color: #ff9800; margin: 20px 0;"></i>
                        <p style="margin: 15px 0;">You need to login to <strong>${action}</strong></p>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Go to Login',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33'
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.setItem('returnUrl', window.location.href);
                    window.location.href = 'login.html';
                }
            });
        }

        // Load product data
        async function loadProduct() {
            const id = new URLSearchParams(window.location.search).get('id') || 1;
            
            try {
                const res = await fetch(`${API_URL}/api/Products/${id}`);
                console.log(res);
                if (!res.ok) throw new Error("Product not found");
                const p = await res.json();
                currentProductData = p;
                
                displayMainProduct(p);
                
                if (p.relatedProducts && Array.isArray(p.relatedProducts) && p.relatedProducts.length > 0) {
                    displayRelatedProducts(p.relatedProducts);
                } else {
                    if (p.categoryId) {
                        await loadRelatedProductsFromCategory(p.categoryId, id);
                    } else {
                        const relatedGrid = document.getElementById('related-products-grid');
                        if (relatedGrid) {
                            relatedGrid.innerHTML = `<p style="grid-column: 1/-1; text-align: center; padding: 20px;">No related products found for this item.</p>`;
                        }
                    }
                }
            } catch (e) { 
                console.error("Error loading product data:", e);
                document.getElementById('product-page').innerHTML = `<div style="text-align: center; padding: 50px;"><h3>Error: Product not found</h3></div>`;
            }
        }

        async function loadRelatedProductsFromCategory(categoryId, currentProductId) {
            try {
                const response = await fetch(`${API_URL}/api/categories/${categoryId}/products`);
                if (!response.ok) {
                    console.warn('Could not load related products');
                    const relatedGrid = document.getElementById('related-products-grid');
                    if (relatedGrid) {
                        relatedGrid.innerHTML = `<p style="grid-column: 1/-1; text-align: center; padding: 20px;">Could not load related products.</p>`;
                    }
                    return;
                }
                
                const data = await response.json();
                
                let products = [];
                if (data.products && data.products.items && Array.isArray(data.products.items)) {
                    products = data.products.items;
                } else if (Array.isArray(data)) {
                    products = data;
                } else if (data.items && Array.isArray(data.items)) {
                    products = data.items;
                } else {
                    console.warn('Unexpected API response format:', data);
                    const relatedGrid = document.getElementById('related-products-grid');
                    if (relatedGrid) {
                        relatedGrid.innerHTML = `<p style="grid-column: 1/-1; text-align: center; padding: 20px;">No related products available.</p>`;
                    }
                    return;
                }
                
                const relatedProducts = products
                    .filter(product => product.id != currentProductId && product.id != null)
                    .slice(0, 6)
                    .map(product => {
                        // Calculate display price
                        const currentDate = new Date();
                        const hasActiveDiscount = product.discountPrice && 
                                                product.discountStartDate && 
                                                product.discountEndDate &&
                                                new Date(product.discountStartDate) <= currentDate &&
                                                new Date(product.discountEndDate) >= currentDate;
                        const displayPrice = hasActiveDiscount ? parseFloat(product.discountPrice) : parseFloat(product.price);
                        
                        return {
                            id: product.id,
                            name: product.name,
                            imageUrl: product.mainImageUrl || product.imageUrl,
                            price: parseFloat(product.price) || 0,
                            displayPrice: displayPrice.toFixed(2),
                            hasDiscount: hasActiveDiscount,
                            rating: product.rating || 4.5,
                            reviewCount: product.reviewCount || 0
                        };
                    });
                
                if (relatedProducts.length > 0) {
                    displayRelatedProducts(relatedProducts);
                } else {
                    const relatedGrid = document.getElementById('related-products-grid');
                    if (relatedGrid) {
                        relatedGrid.innerHTML = `<p style="grid-column: 1/-1; text-align: center; padding: 20px;">No related products found for this item.</p>`;
                    }
                }
            } catch (error) {
                console.error("Error loading related products:", error);
                const relatedGrid = document.getElementById('related-products-grid');
                if (relatedGrid) {
                    relatedGrid.innerHTML = `<p style="grid-column: 1/-1; text-align: center; padding: 20px;">Error loading related products.</p>`;
                }
            }
        }

        // Display main product - مع تعديل بسيط فقط
        function displayMainProduct(p) {
            // Calculate discount info from API response
            const originalPrice = parseFloat(p.price) || 0;
            const discountPrice = p.discountPrice ? parseFloat(p.discountPrice) : null;
            
            // Check if API provides hasDiscount, otherwise calculate from dates
            let hasDiscount = p.hasDiscount;
            if (hasDiscount === undefined && discountPrice) {
                const currentDate = new Date();
                hasDiscount = p.discountStartDate && 
                            p.discountEndDate &&
                            new Date(p.discountStartDate) <= currentDate &&
                            new Date(p.discountEndDate) >= currentDate &&
                            discountPrice < originalPrice;
            } else if (hasDiscount === undefined) {
                hasDiscount = discountPrice && discountPrice < originalPrice && originalPrice > 0;
            }
            
            const displayPrice = p.displayPrice ? parseFloat(p.displayPrice) : (hasDiscount && discountPrice ? discountPrice : originalPrice);
            
            // Calculate discount percentage if not provided
            let discountPercentage = p.discountPercentage;
            if (hasDiscount && !discountPercentage && discountPrice && originalPrice > 0) {
                discountPercentage = Math.round(((originalPrice - discountPrice) / originalPrice) * 100);
            }

            let thumbs = `<img src="${fixImg(p.mainImageUrl)}" class="active" onclick="swap(this)">`;
            if (p.additionalImages && Array.isArray(p.additionalImages)) {
                p.additionalImages.forEach(img => { 
                    thumbs += `<img src="${fixImg(img)}" onclick="swap(this)">`; 
                });
            }

            const list = p.description ? p.description.split('.').filter(t => t.trim()).map(t => `<li>${t.trim()}</li>`).join('') : 'No description available';

            let specRows = "";
            if (p.specifications && Array.isArray(p.specifications) && p.specifications.length > 0) {
                p.specifications.forEach(spec => {
                    specRows += `
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 12px; font-weight: bold; background: #fafafa; color: #333; width: 30%;">${spec.specificationName || 'Specification'}</td>
                            <td style="padding: 12px; color: #666;">${spec.value || ''}</td>
                        </tr>`;
                });
            }

            document.getElementById('product-page').innerHTML = `
                <div class="thumbnails" style="display: flex; flex-direction: column; align-items: center; gap: 10px; max-height: 500px; overflow-y: auto; width: 100px; padding: 10px;">${thumbs}</div>
                
                <div class="main-image-box">
                    <img id="big-img" src="${fixImg(p.mainImageUrl)}">
                    <div class="zoom-icon"><i class="fas fa-search-plus"></i></div>
                </div>

                <div class="product-details">
                    <h1>${p.name}</h1>
                    <div class="stars">
                        <span style="color:#f1c40f">★★★★★</span> 
                        <span style="color:#007185">4.5 (${p.reviewCount || 0} reviews)</span>
                    </div>
                    
                    <div class="price-row">
                        ${hasDiscount ? `
                            <span class="old-price">${parseFloat(p.price).toFixed(2)} EGP</span> 
                            <span class="discount-tag">-${discountPercentage}%</span>
                        ` : ''}
                        <div class="current-price">${parseFloat(displayPrice).toFixed(2)} <small style="font-size:16px">EGP</small></div>
                    </div>

                    <div class="qty-label">Quantity:</div>
                    <div class="qty-selector">
                        <div class="qty-controls">
                            <button onclick="changeQty(-1)">-</button>
                            <input type="text" id="qty" value="1" readonly>
                            <button onclick="changeQty(1)">+</button>
                        </div>
                        <span class="stock-status" style="color: #27ae60">
                            In Stock
                        </span>
                    </div>

                    <div class="action-btns">
                        <button class="btn btn-cart" onclick="addToCart()">
                            <i class="fas fa-shopping-cart"></i> Add to Cart
                        </button>
                        <button class="btn btn-order" onclick="orderNow()">
                            <i class="fas fa-bolt"></i> Order Now
                        </button>
                    </div>
                </div>

                <div class="offer-card">
                    <div>
                        <h2>Exclusive Offer</h2>
                        <p>Order now and get special discounts on accessories</p>
                    </div>
                    <button class="btn-shop" onclick="shopNow()">Shop Now</button>
                </div>

                <div class="description-box">
                    <h3>Product Description</h3>
                    <ul>${list}</ul>

                    <div class="product-specs" style="margin-top: 30px;">
                        <h3 style="margin-bottom: 15px;">Product details</h3>
                        <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd; font-size: 14px;">
                            <tbody>
                                ${specRows || '<tr><td style="padding:15px; text-align:center;">No additional details available</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            updateButtonStyles();
            // تشغيل خاصية الزوم بعد بناء الصفحة
            const mainImg = document.getElementById('big-img');
            const zoomBtn = document.querySelector('.zoom-icon');


if (zoomBtn && mainImg) {
    zoomBtn.onclick = function() {
        mainImg.classList.toggle('is-zoomed');
        
        // تغيير شكل الأيقونة
        const icon = zoomBtn.querySelector('i');
        if (mainImg.classList.contains('is-zoomed')) {
            icon.classList.replace('fa-search-plus', 'fa-search-minus');
        } else {
            icon.classList.replace('fa-search-minus', 'fa-search-plus');
        }
    };

    // اختياري: لو العميل ضغط على الصورة نفسها يقفل الزوم
    mainImg.onclick = function() {
        if (this.classList.contains('is-zoomed')) {
            this.classList.remove('is-zoomed');
            zoomBtn.querySelector('i').classList.replace('fa-search-minus', 'fa-search-plus');
        }
    };
}
        }

        // Display related products
        function displayRelatedProducts(relatedProducts) {
            const relatedGrid = document.getElementById('related-products-grid');
            if (!relatedGrid) return;

            if (!relatedProducts || !Array.isArray(relatedProducts) || relatedProducts.length === 0) {
                relatedGrid.innerHTML = `<p style="grid-column: 1/-1; text-align: center; padding: 20px;">No related products found for this item.</p>`;
                return;
            }

            let html = '';
            
            relatedProducts.forEach(item => {
                // Use displayPrice from API if available, otherwise calculate
                const displayPrice = item.displayPrice || item.price || 0;
                const imageUrl = item.imageUrl || item.mainImageUrl || '';
                const rating = item.rating || 4.5;
                const reviewCount = item.reviewCount || 0;
                
                html += `
                    <div class="card" onclick="window.location.href='product-details.html?id=${item.id}'" style="cursor:pointer">
                        <div class="img-wrap">
                            <img src="${fixImg(imageUrl)}" alt="${item.name}">
                            <button class="fav ${isFav(item.id) ? 'active' : ''}" onclick="toggleFavorite('${item.id}', event)">
                                <i class="${isFav(item.id) ? 'fa-solid' : 'fa-regular'} fa-heart"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="title">${item.name}</div>
                            <div class="rating">
                                <div class="stars"> <span style="color:#f1c40f">★★★★★</span> </div>
                                <span>${rating}</span>
                                <p class="num">(${reviewCount})</p>
                            </div>
                            <div class="price">${parseFloat(displayPrice).toFixed(2)} EGP</div>
                            <button class="btn" onclick="addRelatedToCart('${item.id}', event)">
                                <i class="fa-solid fa-cart-shopping"></i> Add to Cart
                            </button>
                        </div>
                    </div>
                `;
            });
            relatedGrid.innerHTML = html;
        }

        // Add to Cart function
        function addToCart() {
            console.log('Add to Cart clicked');
            
            if (!isUserLoggedIn()) {
                showLoginRequired('add items to cart');
                return false;
            }
            
            const productId = new URLSearchParams(window.location.search).get('id') || 1;
            const quantity = parseInt(document.getElementById('qty')?.value) || 1;
            const productName = currentProductData?.name || document.querySelector('.product-details h1')?.textContent || 'Product';
            
            // Calculate price from API response
            const currentDate = new Date();
            const hasActiveDiscount = currentProductData?.discountPrice && 
                                  currentProductData?.discountStartDate && 
                                  currentProductData?.discountEndDate &&
                                  new Date(currentProductData.discountStartDate) <= currentDate &&
                                  new Date(currentProductData.discountEndDate) >= currentDate;
            const productPrice = hasActiveDiscount ? parseFloat(currentProductData.discountPrice) : parseFloat(currentProductData?.price || '0');
            const productImage = currentProductData?.mainImageUrl ? fixImg(currentProductData.mainImageUrl) : (document.getElementById('big-img')?.src || '');
            
            console.log(`Adding product ${productId} to cart with quantity ${quantity}`);
            
            // Get current cart
            let cart = JSON.parse(localStorage.getItem('shopping_cart')) || [];
            
            // Check if product exists
            const existingProductIndex = cart.findIndex(item => item.id == productId);
            
            if (existingProductIndex !== -1) {
                cart[existingProductIndex].quantity += quantity;
                cart[existingProductIndex].totalPrice = cart[existingProductIndex].quantity * cart[existingProductIndex].price;
            } else {
                const newProduct = {
                    id: productId,
                    name: productName,
                    price: productPrice,
                    quantity: quantity,
                    img: productImage,
                    totalPrice: productPrice * quantity,
                    addedDate: new Date().toISOString()
                };
                cart.push(newProduct);
            }
            
            // Save cart
            localStorage.setItem('shopping_cart', JSON.stringify(cart));
            
            // Update cart count
            updateCartCount();
            
            // Button feedback
            const addToCartBtn = document.querySelector('.btn-cart');
            if (addToCartBtn) {
                const originalText = addToCartBtn.innerHTML;
                const originalBackground = addToCartBtn.style.background;
                
                addToCartBtn.innerHTML = '<i class="fas fa-check"></i> Added!';
                addToCartBtn.style.background = '#28a745';
                addToCartBtn.disabled = true;
                
                setTimeout(() => {
                    addToCartBtn.innerHTML = originalText;
                    addToCartBtn.style.background = originalBackground;
                    addToCartBtn.disabled = false;
                }, 2000);
            }
            
            // Show success message
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'success',
                    title: 'Added to Cart!',
                    html: `
                        <div style="text-align: center;">
                            <i class="fas fa-check-circle" style="font-size: 48px; color: #28a745; margin: 20px 0;"></i>
                            <p style="margin: 15px 0;">${productName} has been added to your cart</p>
                            <p style="font-size: 14px; color: #666;">Quantity: ${quantity}</p>
                            <div style="margin-top: 20px;">
                                <a href="cart.html" style="
                                    background: #3498db;
                                    color: white;
                                    padding: 10px 20px;
                                    border-radius: 4px;
                                    text-decoration: none;
                                    display: inline-block;
                                    margin: 5px;
                                ">View Cart</a>
                                <button onclick="Swal.close()" style="
                                    background: #6c757d;
                                    color: white;
                                    padding: 10px 20px;
                                    border-radius: 4px;
                                    border: none;
                                    cursor: pointer;
                                    margin: 5px;
                                ">Continue Shopping</button>
                            </div>
                        </div>
                    `,
                    showConfirmButton: false,
                    timer: 5000
                });
            }
            
            return false;
        }

        // Add related product to cart
        function addRelatedToCart(productId, event) {
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    
    if (!isUserLoggedIn()) {
        showLoginRequired('add items to cart');
        return false;
    }
    
    // 1. تحديد الزرار اللي انضغط عليه
    const btn = event.currentTarget || event.target;
    // حفظ النص الأصلي عشان نرجعه بعد ثانيتين
    const originalText = btn.innerHTML; 

    // 2. جلب بيانات المنتج
    const card = btn.closest('.card') || btn.closest('.product-card');
    const productName = card ? card.querySelector('.title, h3, .product-name')?.textContent : 'Product ' + productId;
    const productPrice = card ? parseFloat(card.querySelector('.price')?.textContent?.replace(/[^0-9.]/g, '')) : 0;
    const productImage = card ? card.querySelector('img')?.src : '';
    
    // 3. تحديث الـ LocalStorage
    let cart = JSON.parse(localStorage.getItem('shopping_cart')) || [];
    const existingProductIndex = cart.findIndex(item => item.id == productId);
    
    if (existingProductIndex !== -1) {
        cart[existingProductIndex].quantity += 1;
    } else {
        cart.push({
            id: productId,
            name: productName,
            price: productPrice,
            quantity: 1,
            img: productImage,
            totalPrice: productPrice
        });
    }
    
    localStorage.setItem('shopping_cart', JSON.stringify(cart));
    updateCartCount();

    // 4. التأثير البصري (بدل Swal)
    btn.innerHTML = '✓ Added'; // تغيير الكلمة
    btn.style.backgroundColor = '#28a745'; // تغيير اللون للأخضر
    btn.style.borderColor = '#28a745';
    btn.disabled = true; // تعطيل مؤقت عشان ميكررش الضغط

    // 5. يرجع لأصله بعد ثانيتين (2000 مللي ثانية)
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.style.backgroundColor = ''; // هيرجع للونه البرتقالي من الـ CSS
        btn.style.borderColor = '';
        btn.disabled = false;
    }, 2000);

    return false;
}
        // Update cart count in header
        function updateCartCount() {
            const cart = JSON.parse(localStorage.getItem('shopping_cart')) || [];
            const totalItems = cart.reduce((total, item) => total + (item.quantity || 1), 0);
            
            const cartIcon = document.querySelector('.icon-item .fa-shopping-cart')?.closest('.icon-item');
            if (cartIcon) {
                const existingBadge = cartIcon.querySelector('.cart-badge');
                if (existingBadge) existingBadge.remove();
                
                if (totalItems > 0) {
                    const badge = document.createElement('span');
                    badge.className = 'cart-badge';
                    badge.textContent = totalItems > 99 ? '99+' : totalItems;
                    badge.style.cssText = `
                        position: absolute;
                        top: -5px;
                           right: 9px;
                        background: #FF6B00;
                        color: white;
                        border-radius: 50%;
                        width: 18px;
                        height: 17px;
                        font-size: 12px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-weight: bold;
                    `;
                    
                    cartIcon.style.position = 'relative';
                    cartIcon.appendChild(badge);
                }
            }
        }

        // Order Now function - opens modal
        function orderNow() {
            console.log('Order Now clicked');
            
            if (!isUserLoggedIn()) {
                showLoginRequired('place an order');
                return false;
            }
            
            // Open order modal
            openSummary();
            return false;
        }

        // Open summary modal
        function openSummary() {
            if (!isUserLoggedIn()) {
                showLoginRequired('place an order');
                return;
            }

            if (!currentProductData) {
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Product data not loaded yet. Please refresh the page.'
                    });
                }
                return;
            }

            const qty = parseInt(document.getElementById('qty').value) || 1;
            
            // Calculate display price from API response
            const currentDate = new Date();
            const hasActiveDiscount = currentProductData.discountPrice && 
                                  currentProductData.discountStartDate && 
                                  currentProductData.discountEndDate &&
                                  new Date(currentProductData.discountStartDate) <= currentDate &&
                                  new Date(currentProductData.discountEndDate) >= currentDate;
            const unitPrice = hasActiveDiscount ? parseFloat(currentProductData.discountPrice) : parseFloat(currentProductData.price);
            const total = unitPrice * qty;

            document.getElementById('summaryBox').innerHTML = `
                <div class="customer-info-section" style="text-align: left; margin-bottom: 20px;">
                    <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px;">
                        <label style="font-weight: 600; color: #333;">Your Name:</label>
                        <input type="text" id="custName" placeholder="Full Name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px;">
                        <label style="font-weight: 600; color: #333;">Phone Number:</label>
                        <input type="tel" id="custPhone" placeholder="01xxxxxxxxx" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
                    </div>
                </div>

                <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">

                <div style="text-align: left; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: #333;">Order Details</h4>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                        <span>Product:</span>
                        <span style="font-weight: 500;">${currentProductData.name}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                        <span>Quantity:</span>
                        <span>${qty}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding: 8px 0;">
                        <span>Unit Price:</span>
                        <span>${unitPrice.toLocaleString()} EGP</span>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; padding: 15px 0; margin-top: 10px; border-top: 2px solid #eee; font-size: 22px; font-weight: bold; color: #000;">
                    <span>Total:</span>
                    <span style="color: #FF6B00;">${total.toLocaleString()} EGP</span>
                </div>
            `;
            document.getElementById('modalOverlay').style.display = 'flex';
        }

        // Close modal
        function closeModal() {
            document.getElementById('modalOverlay').style.display = 'none';
        }

        // Send to WhatsApp
      // Send to WhatsApp & Sync with Dashboard
      async function sendToWhatsApp() {
            const name = document.getElementById('custName').value.trim();
            const phone = document.getElementById('custPhone').value.trim();
            const qty = document.getElementById('qty').value || 1;
            const token = localStorage.getItem('token') || localStorage.getItem('userToken');

            // 1. التحقق من البيانات
            if (!name || !phone) {
                Swal.fire({ icon: 'warning', title: 'بيانات ناقصة', text: 'يرجى إدخال الاسم ورقم الهاتف' });
                return;
            }

            const phoneRegex = /^01[0-9]{9}$/;
            if (!phoneRegex.test(phone)) {
                Swal.fire({ icon: 'error', title: 'رقم خطأ', text: 'يرجى إدخال رقم هاتف مصري صحيح' });
                return;
            }

            // 2. حساب السعر الحالي (لو فيه خصم أو لاء)
            const currentDate = new Date();
            const hasActiveDiscount = currentProductData.discountPrice && 
                                      currentProductData.discountStartDate && 
                                      currentProductData.discountEndDate &&
                                      new Date(currentProductData.discountStartDate) <= currentDate &&
                                      new Date(currentProductData.discountEndDate) >= currentDate;

            const unitPrice = hasActiveDiscount ? parseFloat(currentProductData.discountPrice) : parseFloat(currentProductData.price);
            const total = unitPrice * qty;

            // 3. الخطوة الأهم: إرسال الأوردر للسيرفر عشان يظهر في الـ Dashboard
            const orderData = {
                customerPhone: phone,
                whatsappNumber: WHATSAPP_NUMBER,
                notes: `طلب مباشر من المنتج: ${currentProductData.name} - اسم العميل: ${name}`,
                items: [{
                    productId: Number(currentProductData.id),
                    quantity: Number(qty)
                }]
            };

            try {
                const response = await fetch(`${API_URL}/api/orders`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify(orderData)
                });

                if (!response.ok) throw new Error('Failed to sync with server');
                console.log("Order added to dashboard successfully!");
            } catch (error) {
                console.error("Dashboard sync error:", error);
                // بنكمل عادي حتى لو السيرفر فيه مشكلة عشان العميل ميعطلش عن الواتساب
            }

            // 4. تنسيق الرسالة اللي طلبتيها بالظبط
            const message = `السلام عليكم، أريد طلب المنتج التالي:%0A%0A` +
                            `*📦 المنتج:* ${currentProductData.name}%0A` +
                            `*💰 السعر:* ${unitPrice.toLocaleString()} EGP%0A` +
                            `*🔢 الكمية:* ${qty}%0A%0A` +
                            `--------------------------%0A` +
                            `*👤 بيانات العميل:*%0A` +
                            `*الاسم:* ${name}%0A` +
                            `*الهاتف:* ${phone}%0A%0A` +
                            `*💵 الإجمالي:* ${total.toLocaleString()} EGP`;

            // 5. فتح الواتساب وقفل المودال
            window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${message}`, '_blank');
            closeModal();
            
            Swal.fire({
                icon: 'success',
                title: 'تم استلام طلبك',
                text: 'سيتم تحويلك للواتساب للتأكيد',
                timer: 2000,
                showConfirmButton: false
            });
        }

        // Shop Now function
        function shopNow() {
            console.log('Shop Now clicked');
            
            if (!isUserLoggedIn()) {
                showLoginRequired('view special offers');
                return false;
            }
            
            window.location.href = 'products.html';
            return false;
        }

        // Update button styles
        function updateButtonStyles() {
            const isLoggedIn = isUserLoggedIn();
            
            setTimeout(() => {
                const mainButtons = document.querySelectorAll('.btn-cart, .btn-order, .btn-shop');
                mainButtons.forEach(btn => {
                    if (btn) {
                        if (!isLoggedIn) {
                            btn.style.opacity = '0.7';
                            btn.title = 'Login required';
                        } else {
                            btn.style.opacity = '1';
                            btn.title = '';
                        }
                    }
                });
                
                // Update header login button
                const loginBtn = document.querySelector('.btn-login');
                if (loginBtn) {
                    if (isLoggedIn) {
                        loginBtn.textContent = 'login';
                        loginBtn.onclick = function(e) {
                            e.preventDefault();
                            window.location.href = 'login.html';
                        };
                    } else {
                        loginBtn.textContent = 'Log In';
                        loginBtn.onclick = function(e) {
                            e.preventDefault();
                            window.location.href = 'login.html';
                        };
                    }
                }
            }, 100);
        }

        // Initialize everything
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded');
            loadProduct();
            updateCartCount();
            updateButtonStyles();
            
            // Load SweetAlert if needed
            if (typeof Swal === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/sweetalert2@11';
                document.head.appendChild(script);
            }
            
            // Add click event to close modal when clicking outside
            document.getElementById('modalOverlay').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
            
            // Add keyboard event to close modal with ESC key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeModal();
                }
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
    // 1. جلب التوكن من الذاكرة
    const token = localStorage.getItem('userToken') || localStorage.getItem('token');
    const accountIcon = document.getElementById('userAccountIcon');

    if (token && accountIcon) {
        try {
            // 2. فك تشفير الجزء الأوسط من التوكن (Payload) لمعرفة الرتبة
            const payload = JSON.parse(window.atob(token.split('.')[1]));
            
            // 3. استخراج الرتبة (Role) - قد تختلف المسميات حسب السيرفر عندك
            const userRole = payload["http://schemas.microsoft.com/ws/2008/06/identity/claims/role"] || payload.role;

            // 4. الشرط: إذا كان يوزر فقط، أظهر الأيقونة
            if (userRole === "User") {
                accountIcon.style.setProperty('display', 'flex', 'important');
            } else {
                // إذا كان أدمن أو غير ذلك، تأكد أنها مخفية
                accountIcon.style.display = 'none';
            }
        } catch (error) {
            console.error("خطأ في قراءة بيانات المستخدم:", error);
            accountIcon.style.display = 'none';
        }
    }
});
        

// استبدلي الجزء المسؤول عن HTML المنتج بهذا الهيكل المطور
/*productPage.innerHTML = `
    <div class="mobile-images-layout">
        <div class="thumbnails-side">${thumbsHtml}</div>
        <div class="main-image-side">
            <img id="big-img" src="${fixImg(p.mainImageUrl)}">
        </div>
    </div>

    <div class="mobile-info-layout">
        <div class="details-side">
            <h1>${p.name}</h1>
            <p class="price-tag">${p.price} EGP</p>
            <div class="action-btns">
                <button class="btn-cart">Add to Cart</button>
                <button class="btn-order">Order Now</button>
            </div>
        </div>
        
        <div class="offer-side">
            <div class="offer-card">
                <h2>Exclusive Offer</h2>
                <p>Order now for discount</p>
                <button class="shop-btn">Shop Now</button>
            </div>
        </div>
    </div>
`;*/


// دالة فحص الحالة (هل هو في المفضلة؟)
// --- 1. ضعي هذه الدوال في أعلى ملف الـ script لضمان تعريفها ---

function isFav(productId) {
    if (!productId) return false;
    let favorites = JSON.parse(localStorage.getItem('user_favorites')) || [];
    return favorites.includes(productId.toString());
}

function updateLocalFavs(productId, isAdd) {
    let favorites = JSON.parse(localStorage.getItem('user_favorites')) || [];
    let pIdStr = productId.toString();

    if (isAdd) {
        if (!favorites.includes(pIdStr)) favorites.push(pIdStr);
    } else {
        favorites = favorites.filter(id => id !== pIdStr);
    }
    localStorage.setItem('user_favorites', JSON.stringify(favorites));
}

async function toggleFavorite(productId, event) {
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }

    if (!isUserLoggedIn()) {
        showLoginRequired('add items to favorites');
        return;
    }

    const token = localStorage.getItem("token");
    const btn = event.currentTarget;
    const icon = btn.querySelector('i');
    const isCurrentlyFav = btn.classList.contains('active');

    // تحديث الشكل فوراً (تجربة مستخدم سريعة)
    if (!isCurrentlyFav) {
        btn.classList.add('active');
        icon.classList.replace('fa-regular', 'fa-solid');
        icon.style.color = "red";
    } else {
        btn.classList.remove('active');
        icon.classList.replace('fa-solid', 'fa-regular');
        icon.style.color = "";
    }

    try {
        let response;
        if (!isCurrentlyFav) {
            // الإرسال كـ Object لحل خطأ 400
            response = await fetch(`${API_URL}/api/Favorites`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    productId: parseInt(productId)
                })
            });
        } else {
            response = await fetch(`${API_URL}/api/Favorites/${productId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
        }

        if (response.ok) {
            console.log("Success: Server updated");
            updateLocalFavs(productId, !isCurrentlyFav);
        } else {
            throw new Error("Server rejected request");
        }
    } catch (error) {
        console.error("Favorite Error:", error);
        // التراجع عن اللون في حالة الفشل
        btn.classList.toggle('active');
        icon.classList.toggle('fa-solid');
        icon.classList.toggle('fa-regular');
        if(!isCurrentlyFav) icon.style.color = "";
    }
}

function handleCartClick() {
    // التحقق من حالة تسجيل الدخول باستخدام الدالة الموجودة في كودك
    if (isUserLoggedIn()) {
        // إذا كان مسجل دخول، يذهب لصفحة العربة
        window.location.href = 'cart.html';
    } else {
        // 1. إظهار الرسالة التي تظهر في الصورة (Alert)
        alert("Please login first");
        
        // 2. بعد الضغط على OK، يتم توجيهه لصفحة تسجيل الدخول
        window.location.href = 'login.html';
    }
}
    </script>

<script src="js/js.js"></script>
</body>
</html>