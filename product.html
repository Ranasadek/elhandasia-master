<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>product </title>
  <link rel="icon" type="image/png" href="img/Logo.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="css/main.css">
</head>
<style>

  

</style>
<body>

<!-- Top Navbar -->

    <header class="main-header">
     
  <div class="logo-area">
    <div class="hamburger">&#9776;</div>

    <img src="img/Logo.png" alt="Logo" class="logo-img">
    <div class="logo-info">
      <h2>Elhandasiya</h2>
      <p>Admin Panel</p>
    </div>
  </div>

  <div class="header-body">
    <div class="welcome">
      <h1>Welcome back, Admin</h1>
      <p>Here's what's happening today</p>
    </div>
    <div class="user-info">
      <strong>Admin User</strong>
      <span>admin@eshop.com</span>
    </div>
  </div>
</header>

<div class="page-container">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="close-btn">&times;</div> <!-- زر الإكس -->
    <nav class="menu">
        <a href="index.html" class="item"><i data-lucide="home"></i>Home</a>
      <a href="Dashboard.html" class="item "><i data-lucide="layout-grid"></i>Dashboard</a>
      <a href="product.html" class="item active"><i data-lucide="package"></i>Products</a>
      <a href="categories.html" class="item"> <i data-lucide="folder"></i>Categories</a>
      <a href="order.html" class="item"><i data-lucide="shopping-cart"></i>Orders</a>
      <a href="brands.html" class="item"><i data-lucide="award"></i>Brands</a>
      <a href="governorates.html" class="item "><i data-lucide="truck"></i>Governorates</a>
      <!-- <a href="#" class="item"><i data-lucide="image"></i>Banners</a> -->
      <!-- <a class="item"><i data-lucide="settings"></i>Settings</a> -->
    </nav>
  </aside>

  <div class="main-content">
    <headers>
        <div class="title-section">
            <h1>Products</h1>
            <p>Manage your product inventory</p>
        </div>
        <div class="actions-section">
            <input type="text" id="searchInput" placeholder="Search products...">
            <a href="add product.html" class="add-btn" style="text-decoration: none; display: inline-flex; align-items: center;">
                + Add Product
            </a>
        </div>
    </headers>

    <div class="table-containers">
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Price</th>
                    <th>DiscountPrice</th>
                    <th>Category</th>
                    <th>Brand</th>
                    <th style="text-align: center;">Actions</th>
                </tr>
            </thead>
            <tbody id="productTableBody">
                <tr><td colspan="6" style="text-align:center; padding:20px;">جاري التجربة بالرابط الجديد...</td></tr>
            </tbody>
        </table>
    </div>
</div>


</div>

<script>
    // تهيئة الأيقونات
    lucide.createIcons();

    const tableBody = document.getElementById('productTableBody');
    const searchInput = document.getElementById('searchInput');
    const BASE_URL = 'https://el-handasia.runasp.net';
    let allProducts = [];

    // دالة الحصول على التوكن من التخزين المحلي
    const getToken = () => localStorage.getItem('userToken') || localStorage.getItem('token');

    // عند تحميل الصفحة
    document.addEventListener('DOMContentLoaded', () => {
        const token = getToken();
        if (!token) {
            handleAuthError('Authentication Required', 'Please login to view products.');
            return;
        }
        fetchProducts();

        // نظام البحث الذكي (بالاسم أو البراند)
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = allProducts.filter(p => 
                    p.name.toLowerCase().includes(term) || 
                    (p.brandName && p.brandName.toLowerCase().includes(term))
                );
                renderTable(filtered);
            });
        }

        // تحكم الـ Sidebar (القائمة الجانبية)
        const sidebarHamburger = document.querySelector('.hamburger');
        const sidebar = document.querySelector('.sidebar');
        const sidebarCloseBtn = document.querySelector('.close-btn');

        if (sidebarHamburger && sidebar && sidebarCloseBtn) {
            sidebarHamburger.addEventListener('click', () => sidebar.classList.add('show'));
            sidebarCloseBtn.addEventListener('click', () => sidebar.classList.remove('show'));
        }
    });

    // جلب المنتجات من الـ API
    async function fetchProducts() {
        const url = `${BASE_URL}/api/admin/products?pageIndex=1&pageSize=100`;
        try {
            const response = await fetch(url, {
                headers: { 'Authorization': `Bearer ${getToken()}` }
            });

            if (response.status === 401) return handleAuthError('Session Expired', 'Please login again.');
            
            const result = await response.json();
            allProducts = result.data || result || [];
            renderTable(allProducts);
        } catch (error) {
            console.error("Fetch error:", error);
            tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">Error loading products</td></tr>`;
        }
    }

    // رسم الجدول وضبط المحاذاة تحت كلمة Actions
    function renderTable(products) {
        if (!products || products.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No products found</td></tr>`;
            return;
        }

        tableBody.innerHTML = products.map(p => {
            const hasDiscount = p.discountPrice && p.discountPrice < p.price;
            return `
                <tr>
                    <td style="font-weight: 500;">${p.name}</td>
                    <td><span class="${hasDiscount ? 'old-price' : ''}">$${p.price}</span></td>
                    <td>${hasDiscount ? '$' + p.discountPrice : '-'}</td>
                    <td><span class="badge" style="background:#f1f5f9; color:#475569; padding:4px 8px; border-radius:4px;">${p.categoryName || 'General'}</span></td>
                    <td><span class="badge" style="background:#f1f5f9; color:#475569; padding:4px 8px; border-radius:4px;">${p.brandName || 'Generic'}</span></td>
                    <td style="text-align: center;">
                        <div style="display: inline-flex; gap: 18px; align-items: center; justify-content: center;">
                            <i class="fa-regular fa-pen-to-square" onclick="editProduct('${p.id}')" 
                               style="cursor: pointer; color: #000; font-size: 18px;" title="Edit"></i>
                            
                            <i class="fa-regular fa-images" onclick="manageProductImages('${p.id}', '${p.name}')" 
                               style="cursor: pointer; color: #3b82f6; font-size: 18px;" title="Gallery"></i>
                            
                            <i class="fa-regular fa-trash-can" onclick="confirmDelete('${p.id}', '${p.name}')" 
                               style="cursor: pointer; color: #ff4d4d; font-size: 18px;" title="Delete"></i>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // --- نظام معرض الصور (المربعات العشرة) ---
    async function manageProductImages(productId, productName) {
        Swal.fire({
            title: `معرض صور: ${productName}`,
            width: '650px',
            html: `
                <div id="gallery-grid" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 12px; border: 1px solid #ddd;"></div>
                <div style="margin-top: 15px; text-align: right; direction: rtl;">
                    <input type="file" id="gallery-input" multiple accept="image/*" style="width:100%;">
                    <button onclick="uploadImages('${productId}')" id="upload-btn" style="width:100%; margin-top:10px; background:#2563eb; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold;">رفع الصور المختارة</button>
                </div>
            `,
            showConfirmButton: false,
            showCancelButton: true,
            cancelButtonText: 'إغلاق',
            didOpen: () => refreshGallery(productId)
        });
    }

    async function refreshGallery(productId) {
    const grid = document.getElementById('gallery-grid');
    try {
        // 1. جلب تفاصيل المنتج عشان نعرف الـ Main Image بتاعته إيه
        const productRes = await fetch(`${BASE_URL}/api/admin/products/${productId}`, {
            headers: { 'Authorization': `Bearer ${getToken()}` }
        });
        const productData = await productRes.json();
        const mainImageUrl = productData.mainImageUrl; // الرابط الأساسي

        // 2. جلب صور المعرض
        const response = await fetch(`${BASE_URL}/api/admin/products/${productId}/images`, {
            headers: { 'Authorization': `Bearer ${getToken()}` }
        });
        const allGalleryImages = await response.json();

        // 3. فلترة الصور: استبعاد أي صورة تطابق الـ Main Image
        const filteredImages = allGalleryImages.filter(img => img.imageUrl !== mainImageUrl);

        let gridHtml = '';
        for (let i = 0; i < 10; i++) {
            if (filteredImages[i]) {
                const imgUrl = filteredImages[i].imageUrl.startsWith('http') 
                    ? filteredImages[i].imageUrl 
                    : `${BASE_URL}${filteredImages[i].imageUrl}`;
                
                gridHtml += `
                    <div style="position: relative; aspect-ratio: 1/1; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background: white;">
                        <img src="${imgUrl}?v=${Date.now()}" style="width: 100%; height: 100%; object-fit: cover;">
                        <button onclick="deleteImg('${productId}', '${filteredImages[i].id}')" 
                                style="position: absolute; top: 2px; right: 2px; background: #ef4444; color: white; border: none; width: 22px; height: 22px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                            &times;
                        </button>
                    </div>`;
            } else {
                gridHtml += `<div style="aspect-ratio: 1/1; border: 2px dashed #ccc; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #ccc;"><i class="fa-regular fa-image" style="font-size:20px;"></i></div>`;
            }
        }
        grid.innerHTML = gridHtml;
    } catch (e) { 
        console.error("Gallery Refresh Error:", e); 
    }
}
    // رفع الصور وحل مشكلة الـ ProductId
    async function uploadImages(productId) {
        const input = document.getElementById('gallery-input');
        const btn = document.getElementById('upload-btn');
        if (input.files.length === 0) return alert("الرجاء اختيار ملفات");

        const formData = new FormData();
        formData.append('ProductId', productId); // إرسال الـ ID لفك تعارض السيرفر
        for (let file of input.files) {
            formData.append('Images', file); 
        }

        btn.disabled = true;
        btn.innerText = "جاري الرفع...";

        try {
            const response = await fetch(`${BASE_URL}/api/admin/products/${productId}/images`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${getToken()}` },
                body: formData 
            });

            if (response.ok) {
                input.value = "";
                refreshGallery(productId);
            } else {
                alert("حدث خطأ في الرفع، تأكد من حجم الصور.");
            }
        } catch (e) { alert("فشل الاتصال بالسيرفر"); }
        finally { btn.disabled = false; btn.innerText = "رفع الصور"; }
    }

    // حذف صورة من المعرض
    async function deleteImg(pId, imgId) {
        if (!confirm("هل تريد حذف هذه الصورة؟")) return;
        try {
            await fetch(`${BASE_URL}/api/admin/products/${pId}/images/${imgId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${getToken()}` }
            });
            refreshGallery(pId);
        } catch (e) { console.error(e); }
    }

    // --- وظائف الحذف والتعديل الأساسية للمنتج ---
    async function confirmDelete(productId, productName) {
        const result = await Swal.fire({
            title: 'هل أنت متأكد؟',
            text: `سيتم حذف المنتج "${productName}" نهائياً`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'نعم، احذف!'
        });

        if (result.isConfirmed) {
            const response = await fetch(`${BASE_URL}/api/admin/products/${productId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${getToken()}` }
            });

            if (response.ok) {
                allProducts = allProducts.filter(p => p.id != productId);
                renderTable(allProducts); 
                Swal.fire('تم الحذف!', 'تمت العملية بنجاح.', 'success');
            }
        }
    }

    function editProduct(id) {
        window.location.href = `edit-product.html?id=${id}`;
    }

    function handleAuthError(title, text) {
        Swal.fire({ icon: 'error', title, text }).then(() => {
            localStorage.clear();
            window.location.href = 'login.html';
        });
    }
</script>




<script>
    lucide.createIcons();
  
    document.addEventListener('DOMContentLoaded', () => {
  
      // -------- Sidebar Hamburger --------
      const sidebarHamburger = document.querySelector('.hamburger'); // متغير مختلف عشان ما يتعارضش
      const sidebar = document.querySelector('.sidebar');
      const sidebarCloseBtn = document.querySelector('.close-btn');
  
      if (sidebarHamburger && sidebar && sidebarCloseBtn) {
        sidebarHamburger.addEventListener('click', () => {
          sidebar.classList.add('show'); // فتح الـ sidebar
        });
  
        sidebarCloseBtn.addEventListener('click', () => {
          sidebar.classList.remove('show'); // غلق الـ sidebar
        });
      }
  
      // -------- Sidebar Active Toggle --------
      const menuItems = document.querySelectorAll('.menu .item');
  
      menuItems.forEach(item => {
        item.addEventListener('click', () => {
          // إزالة active من كل العناصر
          menuItems.forEach(el => el.classList.remove('active'));
  
          // إضافة active للعنصر اللي اتضغط
          item.classList.add('active');
        });
      });
  
      // أي كود جديد ممكن تضيفيه هنا بدون مشاكل
      // مثال: hamburger آخر لقائمة موبايل
      const mobileMenuIcon = document.querySelector('.mobile-menu-icon'); // لو موجود
      const mobileCategories = document.querySelector('.mobile-categories'); // لو موجود
  
      if (mobileMenuIcon && mobileCategories) {
        mobileMenuIcon.addEventListener('click', () => {
          mobileCategories.classList.toggle('show');
        });
  
        document.addEventListener('click', (e) => {
          if (!mobileCategories.contains(e.target) && !mobileMenuIcon.contains(e.target)) {
            mobileCategories.classList.remove('show');
          }
        });
      }
  
    });
  </script>
</body>
</html>
